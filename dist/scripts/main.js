"use strict";function building(t,i,e,s,o,a){this.type=t,this.id=i,this.x=e,this.y=s,this.cost=o,this.level=a,this.house=0}function lowestBuilding(t,i){if(void 0===t[0])return!1;for(var e=0;e<t.length;e++)if(t[e].type===i&&t[e].level<5)return e}function constructBuilding(){var t,i=void 0,e=void 0,s=void 0;if(i=player.buildingList.length+1,e=lowestBuilding(player.buildingList,this.id),s=player.buildingList[e],"number"==typeof e){if(s.level<5&&(s.levelUp(),s.level>=5)){t=s.id;var o=new building(this.id,t,0,0,1,0);o.buildHouse()}}else{var a=new building(this.id,i,0,0,1,0);a.buildHouse()}player.build(),storeUser()}function include(t,i,e){return e?t.map(function(t){return t.type}).indexOf(i):t.indexOf(i)!=-1}function addBuilding(t){var i=void 0;if("object"===("undefined"==typeof t?"undefined":_typeof(t))&&(t=document.getElementById("buildingName").value),i=JSON.stringify(t),!include(buttonList,i)||0===buttonList.length){var e=void 0,s=void 0,o=void 0;o=document.getElementById("buildingBtn"),e=document.createElement("button"),e.id=t,e.setAttribute("class","houseBtn"),s=document.createTextNode(t),e.appendChild(s),o.appendChild(e),document.getElementById(e.id).onclick=constructBuilding,buttonList.push(i)}}function storeUser(){player.population=popCtrl.popList.length;var t=localStorage;t.stored=!0;for(var i in player)"function"!=typeof player[i]&&player[i].constructor!==Array?t[i]=player[i]:player[i].constructor===Array&&player.buildingList.length>0&&(t[i]=JSON.stringify(player.buildingList,["type","id","x","y","cost","level","house"]))}function loadUser(){var t=localStorage;for(var i in t)for(var e in player)if(e===i)if("buildingList"===i)for(var s=JSON.parse(t.getItem("buildingList")),o=0;o<s.length;o++)player[e].push(s[o].type=new building(s[o].type,s[o].id,s[o].x,s[o].y,s[o].cost,s[o].level)),addBuilding(s[o].type.type);else player[e]=parseInt(t[i]),"population"===e&&popCtrl.create(player[e])}function folk(t,i,e,s,o){this.x=t,this.y=i,this.height=s,this.width=o,this.speedX=1,this.speedY=1,this.id=e,this.walkedTiles=0,this.switchDir=0,this.tileX=0,this.tileY=0}function init(){removeEventListener("load",init),isometric.width=20,isometric.createMap(),isometric.loadImg(),localStorage.stored&&loadUser(),player.build(),gameLoop()}function update(){ctx.clearRect(0,0,canvasWidth,canvasHeight),popCtrl.update(),player.drawPlayerStats(),pomodoroBtn.pressed&&pomodoroBtn.drawClock(isometric.buildCtx),textEvent.showMsg()}function gameLoop(){requestAnimationFrame(gameLoop,canvas),update()}function getMousePos(t,i){var e=t.getBoundingClientRect();return{x:i.clientX-e.left,y:i.clientY-e.top}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};building.prototype.buildHouse=function(){if(player.pomodoros>=this.cost){if(isometric.scanTiles(),isometric.scanTiles.length>0){this.house++;var t=Math.floor(Math.random()*isometric.freeTiles.length);displayMsg=!0,textEvent.text="You've constructed: "+this.type,textEvent.duration=4e3,this.x=isometric.freeTiles[t].x,this.y=isometric.freeTiles[t].y,player.buildingList.push(this),player.pomodoros-=this.cost,this.levelUp()}}else displayMsg=!0,textEvent.text="not enough pomodoros",textEvent.duration=4e3},building.prototype.levelUp=function(){player.pomodoros>=this.cost?(this.level++,player.pomodoros-=this.cost,player.totLvlCalc(),this.cost+=Math.ceil(this.cost*this.level/2/this.level),displayMsg=!0,textEvent.text=this.type+" "+this.house+" is now lvl:"+this.level,textEvent.duration=4e3,popCtrl.increase(this.level)):(displayMsg=!0,textEvent.text="Not enough pomodoros, you have to work more",textEvent.duration=4e3)},document.getElementById("newBuilding").onclick=addBuilding;var buttonList=[],gong=new Audio("../gongTest.mp3"),pomodoroBtn={x:350,y:500,time:0,pressed:!1,radius:10,color:"#4DBD33",state:"active",min:0,sec:0,drawClock:function(t){t.clearRect(0,0,750,750);var i=200,e=200;this.drawImage(t,"../images/"+this.state+".png",i,e),drawText(t,this.time,"40px Bungee Shade","black","center",350,252)},drawImage:function(t,i,e,s){var o=new Image;o.src=i,t.drawImage(o,e,s)},clearBtn:function(t,i,e){gong.play(),pomodoroBtn.pressed=!1,t.clearRect(0,0,i,e),player.buildingList.length>0&&isometric.drawBuildings()}},player={buildingList:[],pomodoros:0,totPom:0,pause:0,totLvl:0,population:0,totLvlCalc:function(){this.totLvl=0;for(var t=0;t<this.buildingList.length;t++)this.totLvl+=this.buildingList[t].level},build:function(){for(var t=0;t<this.buildingList.length;t++){var i=this.buildingList[t].x,e=this.buildingList[t].y;this.buildingList[t].id>3&&(this.buildingList[t].id=Math.floor(3*Math.random()+1)),isometric.map[i][e]=this.buildingList[t].id,isometric.heightMap[i][e]=this.buildingList[t].level}isometric.drawBuildings()},drawPlayerStats:function(){ctx.font="15px Courier New",ctx.fillStyle="black",ctx.textAlign="left",ctx.fillText("Pomodoros: "+this.pomodoros,10,100),ctx.fillText("Breaks: "+this.pause,10,130),ctx.fillText("Population: "+popCtrl.popList.length,10,160),ctx.fillText("buildings: "+this.buildingList.length,10,190),ctx.fillText("TotalLevel: "+this.totLvl,10,220)}};folk.prototype.draw=function(t){var i=void 0,e=void 0;t.fillStyle="white",t.fillRect(this.x,this.y,this.width,this.height),i=this.width/2,e=this.height/2,t.fillStyle="#00aecc",t.fillRect(this.x+i/2,this.y,i,e)},folk.prototype.move=function(t){var i=Math.floor(this.x+this.speedX),e=Math.floor(this.y+this.speedY),s=.1,o=Math.floor(this.x),a=Math.floor(this.y);this.walkedTiles>=this.switchDir&&(this.speedX=Math.random()>.5?s:-s,this.speedY=Math.random()>.5?s:-s,this.walkedTiles=0,this.switchDir=Math.floor(Math.random()*Math.pow(isometric.width,2)/20+20));for(var r=0;r<isometric.map.length;r++)for(var n=0;n<isometric.map.length;n++){var l=(r-n)*isometric.tileH+isometric.mapX,h=(r+n)*isometric.tileH/2+isometric.mapY;if(o<=l+isometric.tileW&&o>=l&&a<=h+isometric.tileH/2&&a>=h&&(this.tileX!==r?(this.walkedTiles++,this.tileX=r):this.tileY!==n&&(this.walkedTiles++,this.tileY=n)),i<=l+isometric.tileW&&i>=l&&e<=h+isometric.tileH/2&&e>=h)switch(isometric.map[r][n]){case-1:this.speedX=s,this.speedY=s;break;case-2:this.speedX=s,this.speedY=-s;break;case-3:this.speedX=-s,this.speedY=-s;break;case-4:this.speedX=-s,this.speedY=s}}this.x+=this.speedX,this.y+=this.speedY,this.draw(t)};var popCtrl={popList:[],context:"canvas",update:function(){for(var t=0;t<this.popList.length;t++)this.popList[t].move(this.context)},create:function(t){for(var i=0;i<t;i++){var e=Math.floor(isometric.width/2+isometric.mapX),s=isometric.mapY+isometric.mapY/2;this.popList.push(new folk(e,s,i,Math.ceil(5*(Math.random()+1)),Math.ceil(3*(Math.random()+1))))}},increase:function(t){var i=void 0;i=.5*t,this.create(i)}},isometric={width:0,map:[],heightMap:[],freeTiles:[],tileGraphicsToLoad:["../images/grass-boxtest2.png","../images/tube-bot.png","../images/tube-mid.png","../images/tube-top.png","../images/pcb-bot.png","../images/pcb-mid.png","../images/pcb-top.png","../images/temple-bot.png","../images/temple-mid.png","../images/temple-top.png"],topBox:[],midBox:[],botBox:[],tileGraphics:[],tileGraphicsLoaded:0,tileH:13,tileW:25,mapX:350,mapY:200,xCoord:[],yCoord:[],mapCtx:document.getElementById("main").getContext("2d"),buildCtx:document.getElementById("buildings").getContext("2d"),scanTiles:function(t){for(var i=0;i<this.width;i++)for(var e=0;e<this.width;e++)0===this.map[i][e]&&this.freeTiles.push({x:i,y:e})},createMap:function(){for(var t=0;t<this.width;t++){this.map.push([]),this.heightMap.push([]);for(var i=0;i<this.width;i++)0===t?this.map[t].push(-1):t===this.width-1?this.map[t].push(-3):i===this.width-1?this.map[t].push(-2):0===i?this.map[t].push(-4):(this.map[t].push(0),this.heightMap[t].push(0))}},loadImg:function(){for(var t=0;t<this.tileGraphicsToLoad.length;t++){var i=this.tileGraphicsToLoad[t].length-5,e=new Image;e.src=this.tileGraphicsToLoad[t],e.onload=function(){isometric.tileGraphicsLoaded++,isometric.tileGraphicsLoaded==isometric.tileGraphicsToLoad.length&&(isometric.drawMap(),isometric.drawBuildings())},"p"===this.tileGraphicsToLoad[t][i]?this.topBox.push(e):"d"===this.tileGraphicsToLoad[t][i]?this.midBox.push(e):"t"===this.tileGraphicsToLoad[t][i]?this.botBox.push(e):this.tileGraphics.push(e)}},drawMap:function(){for(var t=0;t<this.map.length;t++)for(var i=0;i<this.map.length;i++)this.xCoord.push((t-i)*this.tileH+this.mapX),this.yCoord.push((t+i)*this.tileH/2+this.mapY),this.mapCtx.drawImage(this.tileGraphics[0],(t-i)*this.tileH+this.mapX,(t+i)*this.tileH/2+this.mapY)},drawBuildings:function(){this.buildCtx.clearRect(0,0,canvasWidth,canvasHeight);for(var t,i,e,s=0;s<this.map.length;s++)for(var o=0;o<this.map.length;o++)if(t=this.map[s][o],i=this.heightMap[s][o],e=t-1,t>0)for(var a=1;a<=i;a++)a<=1?this.buildCtx.drawImage(this.botBox[e],(s-o)*this.tileH+this.mapX,(s+o)*this.tileH/2+this.mapY-this.tileH*a):a>1&&a<i?this.buildCtx.drawImage(this.midBox[e],(s-o)*this.tileH+this.mapX,(s+o)*this.tileH/2+this.mapY-this.tileH*a):a===i&&this.buildCtx.drawImage(this.topBox[e],(s-o)*this.tileH+this.mapX,(s+o)*this.tileH/2+this.mapY-this.tileH*a)}};onmessage=function(t){switch(t.data){case"active":var i=25,e=0;postMessage(i+":"+e);var s=setInterval(function(){0==i&&0==e?(clearInterval(s),postMessage("break")):0==e?(i--,e=59):e--,e<10?postMessage(i+":0"+e):postMessage(i+":"+e)},1e3);break;case"break":var i=5,e=0;postMessage(i+":"+e);var o=setInterval(function(){0==i&&0==e?(postMessage("active"),clearInterval(o)):0==e?(i--,e=59):e--,e<10?postMessage(i+":0"+e):postMessage(i+":"+e)},1e3)}},function(){var t=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;window.requestAnimationFrame=t}();var c=document.getElementById("canvas"),ctx=c.getContext("2d"),canvasWidth=700,canvasHeight=700,displayMsg=!1;popCtrl.context=ctx,buildings.addEventListener("mousedown",function(t){getMousePos(canvas,t);pomodoroBtn.pressed||(pomodoroBtn.pressed=!0,myWorker.postMessage(pomodoroBtn.state)),storeUser()},!1),addEventListener("load",init,!1);var textEvent={text:"String",font:"20px Courier New",color:"black",align:"center",x:canvasWidth/2,y:canvasWidth/4,duration:0,drawText:function(){ctx.font=this.font,ctx.fillStyle=this.color,ctx.textAlign=this.align,ctx.fillText(text,x,y)},showMsg:function(){displayMsg&&"string"!==this.text&&(this.drawText(),setTimeout(function(){displayMsg=!1},this.duration))}};if(window.Worker){var myWorker=new Worker("../scripts/timeWorker.js"),result;myWorker.onmessage=function(t){result=t.data,"active"==result||"break"==result?(pomodoroBtn.state=result,pomodoroBtn.clearBtn(isometric.buildCtx,canvasWidth,canvasHeight)):(pomodoroBtn.time=result,document.title=pomodoroBtn.state+" "+result)}}else alert("Your browser does not support webworkers, get a better browser...");